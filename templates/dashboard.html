<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      /* 確保 tank 可以定位與定義高度 */
      #tank {
        position: relative;
        width: 90vw;
        height: 800px; /* 或你想要的高度 */
        overflow: hidden;
        border: 4px solid #44f;
        margin: 0 auto;
        background: rgba(0, 0, 0, 0.2);
      }

      #water {
        position: absolute;
        bottom: 0;
        width: 100%;
        background: #44f;
        height: 0%;
        transition: height 0.5s;
      }
      /* 泡泡的樣式與動畫 */
      @keyframes rise {
        0% {
          transform: translateY(0);
          opacity: 1;
        }
        100% {
          transform: translateY(-800px); /* 跑出頂部 */
          opacity: 0.2;
        }
      }

      .bubble {
        position: absolute;
        bottom: 0;
        width: 20px;
        height: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        animation: rise 4s ease-in infinite;
      }
    </style>
  </head>
  <body class="bg-black text-white p-4">
    <h1 class="text-4xl mb-4">實時儀表板</h1>
    <div id="time" class="text-2xl mb-2"></div>
    <div id="group" class="text-2xl mb-2"></div>
    <div id="singers" class="text-xl mb-6"></div>
    <div id="tank"><div id="water"></div></div>

    <script>
      // 香港時間
      function updateTime() {
        let now = new Date().toLocaleString("en-US", {
          timeZone: "Asia/Hong_Kong",
        });
        document.getElementById("time").textContent =
          "時間：" + new Date(now).toLocaleTimeString();
      }
      setInterval(updateTime, 1000);
      updateTime();

      const socket = io();
      const grpEl = document.getElementById("group");
      const singEl = document.getElementById("singers");
      const water = document.getElementById("water");

      socket.on("group_changed", (g) => {
        grpEl.textContent = `組別：${g.id} – ${g.name}`;
        singEl.textContent = "歌手：" + g.singers.join("，");
        water.style.height = "0%";
      });

      socket.on("vote_update", (d) => {
        let pct = (d.count / 4) * 100;
        water.style.height = pct + "%";
      });

      socket.on("all_reset", () => {
        grpEl.textContent = "";
        singEl.textContent = "";
        water.style.height = "0%";
      });

      function makeBubble() {
        const tank = document.getElementById("tank");
        const b = document.createElement("div");
        b.className = "bubble";
        // 隨機 horizontal 位置
        const maxLeft = tank.clientWidth - 12;
        b.style.left = Math.random() * maxLeft + "px";

        tank.appendChild(b);
        // 4s 之後自動移除
        setTimeout(() => tank.removeChild(b), 4000);
      }

      setInterval(makeBubble, 150);

      socket.on("do_refresh", () => location.reload());
      socket.on("do_refresh_dashboard", () => location.reload());
    </script>
  </body>
</html>
